name: Release Catime

on:
  push:
    tags:
      - 'v*'

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up China timezone
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        echo "Current timezone: $(date +%Z)"
        echo "Current time: $(date)"
        
    - name: Install MinGW compiler and CMake
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64 cmake
        cmake --version
        
    - name: Extract version number
      id: get_version
      run: |
        VERSION=$(grep -oP '#define CATIME_VERSION "\K[^"]+' resource/resource.h)
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Version: $VERSION"
        # Get tag name without 'v' prefix
        TAG_VERSION=${GITHUB_REF#refs/tags/v}
        echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_ENV
      
    - name: Build application
      run: |
        # Create build directory
        mkdir -p build
        cd build
        
        # Configure CMake with MinGW cross-compilation
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=../mingw-w64-toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_RC_COMPILER=x86_64-w64-mingw32-windres
        
        # Build the project
        make -j$(nproc)
        
        # Copy and rename the executable
        cp catime.exe ../catime_${{ env.TAG_VERSION }}.exe
        echo "Build completed using CMake"
        
    - name: Create GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        files: catime_${{ env.TAG_VERSION }}.exe
        name: ${{ github.ref_name }}
        body: |
          # ğŸ“ Changelog

          > [!TIP]
          > My friend, while downloading Catime, why not check out my friend's [Easy-Cat-Timer](https://github.com/xujiangjiang/Easy-Cat-Timer)â€” a super cute and practical countdown timer!
          > æˆ‘çš„æœ‹å‹ï¼Œåœ¨ä¸‹è½½ Catime æ—¶ï¼Œä¸å¦¨é¡ºä¾¿çœ‹çœ‹æˆ‘æœ‹å‹å¼€å‘çš„ [Easy-Cat-Timer](https://github.com/xujiangjiang/Easy-Cat-Timer)â€”â€”ä¸€æ¬¾è¶…çº§å¯çˆ±åˆå®ç”¨çš„å€’è®¡æ—¶è½¯ä»¶ï¼
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
